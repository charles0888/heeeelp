<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>í•œêµ­ì–´ ë°œìŒ í…ŒìŠ¤íŠ¸</title>
<style>
body { font-family: 'Pretendard', sans-serif; background-color: #f4f4f4; display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh; }
h1 { margin-bottom: 20px; }
#sentence { font-size:1.2em; background:#fff; padding:15px 25px; border-radius:10px; box-shadow:0 0 5px rgba(0,0,0,0.2); margin-bottom:20px; text-align:center; width:80%; }
#timer { font-size:1.2em; color:#d9534f; margin-bottom:15px; }
button { padding:12px 25px; font-size:1em; border:none; border-radius:10px; cursor:pointer; background:#007bff; color:white; }
#result { margin-top:20px; font-size:1.1em; }
</style>
</head>
<body>
<h1>ğŸ¤ í•œêµ­ì–´ ë°œìŒ í…ŒìŠ¤íŠ¸</h1>
<div id="sentence">í…ŒìŠ¤íŠ¸ ë¬¸ì¥ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
<div id="timer">ë‚¨ì€ ì‹œê°„: 0ì´ˆ</div>
<button id="startBtn">ì‹œì‘</button>
<div id="result"></div>

<script>
const sentences = [
  { text: "ê°„ì¥ ê³µì¥ ê³µì¥ì¥ì€ ê°• ê³µì¥ì¥ì´ê³  ëœì¥ ê³µì¥ ê³µì¥ì¥ì€ ê³µ ê³µì¥ì¥ì´ë‹¤.", time: 8 },
  { text: "ë‚´ê°€ ê·¸ë¦° ê¸°ë¦° ê·¸ë¦¼ì€ ëª©ì´ ê¸´ ê¸°ë¦° ê·¸ë¦° ê·¸ë¦¼ì´ê³ , ë„¤ê°€ ê·¸ë¦° ê¸°ë¦° ê·¸ë¦¼ì€ ëª©ì´ ì•ˆ ê¸´ ê¸°ë¦° ê·¸ë¦¼ì´ë‹¤.", time: 8 },
  { text: "ì €ê¸° ê³„ì‹  ì € ë¶„ì´ ë°• ë²•í•™ë°•ì‚¬ì´ì‹œê³  ì—¬ê¸° ê³„ì‹  ì´ ë¶„ì´ ë°± ë²•í•™ë°•ì‚¬ì´ì‹œë‹¤.", time: 8 },
  { text: "ê²½ì°°ì²­ ì°½ì‚´ì€ ì™¸ì² ì°½ì‚´ì´ê³  ê²€ì°°ì²­ ì°½ì‚´ì€ ìŒì² ì°½ì‚´ì´ë‹¤.", time: 6 },
  { text: "í•œì–‘ ì–‘ì¥ì  ì˜† í•œì˜ ì–‘ì¥ì .", time: 6 }
];

const sentenceDiv = document.getElementById("sentence");
const resultDiv = document.getElementById("result");
const timerDiv = document.getElementById("timer");
const startBtn = document.getElementById("startBtn");

let recognition;
let timer;
let timeLeft = 0;
let currentSentence = null;

// ìŠ¤í˜ì´ìŠ¤ë°”ë¡œ ì‹œì‘, ì‰¬í”„íŠ¸ë¡œ ë¬¸ì¥ ë³€ê²½
document.addEventListener("keydown", (e) => {
  if (e.code === "Space") { 
    e.preventDefault();
    if (!startBtn.disabled) startTest();
  }
  if (e.code === "ShiftLeft" || e.code === "ShiftRight") {
    changeRandomSentence();
  }
});

startBtn.addEventListener("click", startTest);

function startTest() {
  pickRandomSentence();
  resultDiv.textContent = "";
  startBtn.disabled = true;
  timerDiv.textContent = "ëŒ€ê¸° ì¤‘: 3ì´ˆ";

  let prepTime = 3;
  const prepInterval = setInterval(() => {
    prepTime--;
    timerDiv.textContent = `ëŒ€ê¸° ì¤‘: ${prepTime}ì´ˆ`;
    if (prepTime <= 0) {
      clearInterval(prepInterval);
      beginRecognition(currentSentence.text, currentSentence.time);
    }
  }, 1000);
}

function pickRandomSentence() {
  const random = sentences[Math.floor(Math.random() * sentences.length)];
  currentSentence = { ...random };
  sentenceDiv.textContent = currentSentence.text;
}

function changeRandomSentence() {
  if (recognition) recognition.stop(); // ì§„í–‰ ì¤‘ ë…¹ìŒ ì¢…ë£Œ
  pickRandomSentence();
  resultDiv.textContent = "";
  timerDiv.textContent = `ë‚¨ì€ ì‹œê°„: ${currentSentence.time}ì´ˆ`;
  startBtn.disabled = false;
}

function beginRecognition(sentence, limit) {
  timeLeft = limit;
  timerDiv.textContent = `ë‚¨ì€ ì‹œê°„: ${timeLeft}ì´ˆ`;

  recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
  recognition.lang = "ko-KR";
  recognition.continuous = true;
  recognition.interimResults = true;

  let finalTranscript = "";

  recognition.onresult = (event) => {
    for (let i = event.resultIndex; i < event.results.length; i++) {
      const transcript = event.results[i][0].transcript;
      if (event.results[i].isFinal) finalTranscript += transcript;
    }
  };

  recognition.start();

  timer = setInterval(() => {
    timeLeft--;
    timerDiv.textContent = `ë‚¨ì€ ì‹œê°„: ${timeLeft}ì´ˆ`;
    if (timeLeft <= 0) {
      clearInterval(timer);
      recognition.stop();
    }
  }, 1000);

  recognition.onend = () => {
    startBtn.disabled = false;
    timerDiv.textContent = "ì‹œê°„ ì¢…ë£Œ!";
    calculateScore(sentence, finalTranscript);
  };
}

// ìëª¨ ê¸°ë°˜ ì ìˆ˜ ê³„ì‚°
function calculateScore(target, spoken) {
  if (!spoken) {
    resultDiv.textContent = "ìŒì„±ì´ ì¸ì‹ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤ ğŸ˜¢";
    return;
  }
  const distance = levenshtein(jamoSplit(target), jamoSplit(spoken));
  const maxLen = Math.max(jamoSplit(target).length, jamoSplit(spoken).length);
  const similarity = Math.max(0, (1 - distance / maxLen) * 100);
  resultDiv.textContent = `ğŸ¯ ë°œìŒ ì ìˆ˜: ${similarity.toFixed(1)}ì `;
}

// ìëª¨ ë¶„ë¦¬
function jamoSplit(str) {
  const chosung=["ã„±","ã„²","ã„´","ã„·","ã„¸","ã„¹","ã…","ã…‚","ã…ƒ","ã……","ã…†","ã…‡","ã…ˆ","ã…‰","ã…Š","ã…‹","ã…Œ","ã…","ã…"];
  const jungsung=["ã…","ã…","ã…‘","ã…’","ã…“","ã…”","ã…•","ã…–","ã…—","ã…˜","ã…™","ã…š","ã…›","ã…œ","ã…","ã…","ã…Ÿ","ã… ","ã…¡","ã…¢","ã…£"];
  const jongsung=["","ã„±","ã„²","ã„³","ã„´","ã„µ","ã„¶","ã„·","ã„¹","ã„º","ã„»","ã„¼","ã„½","ã„¾","ã„¿","ã…€","ã…","ã…‚","ã…„","ã……","ã…†","ã…‡","ã…ˆ","ã…Š","ã…‹","ã…Œ","ã…","ã…"];
  return Array.from(str).map(ch=>{
    const code=ch.charCodeAt(0)-0xAC00;
    if(code<0||code>11171) return ch;
    const cho=Math.floor(code/588);
    const jung=Math.floor((code%588)/28);
    const jong=code%28;
    return chosung[cho]+jungsung[jung]+jongsung[jong];
  }).join('');
}

// ë ˆë²¤ìŠˆíƒ€ì¸ ê±°ë¦¬
function levenshtein(a,b){
  const dp=Array.from({length:a.length+1},()=>Array(b.length+1).fill(0));
  for(let i=0;i<=a.length;i++) dp[i][0]=i;
  for(let j=0;j<=b.length;j++) dp[0][j]=j;
  for(let i=1;i<=a.length;i++){
    for(let j=1;j<=b.length;j++){
      dp[i][j]=a[i-1]===b[j-1]?dp[i-1][j-1]:Math.min(dp[i-1][j],dp[i][j-1],dp[i-1][j-1])+1;
    }
  }
  return dp[a.length][b.length];
}
</script>
</body>
</html>
